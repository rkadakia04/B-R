<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Canvas Video Overlay</title>
  <style>
    canvas {
      position: absolute;
      top: 0px;
      left: 0px;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <script>
    const mediaSource = "http://upload.wikimedia.org/wikipedia/commons/7/79/Big_Buck_Bunny_small.ogv";

    var showHelp = true;
    var bgReady = false;

    // create and load background image
    const bgImg = new Image;
    bgImg.src = "https://i.stack.imgur.com/C7qq2.png?s=256&g=1";
    bgImg.addEventListener("load", () => bgReady = true, {once: true});
    const canvas = document.getElementById("canvas");
    const W = window.innerWidth, H = window.innerHeight;
    canvas.width = W;
    canvas.height = H;
    const ctx = canvas.getContext("2d");

    // Show state and setup help settings
    ctx.font = "32px arial";
    ctx.fillText("Loading...", 30, 60);
    ctx.font = "24px arial";
    ctx.fillStyle = "#FFF";
    ctx.strokeStyle = "#000";
    ctx.lineJoin = "round";
    ctx.lineWidth = 4;  

    // setup overlay canvas
    const overlay = copyImg(canvas);
    const ctxO = overlay.getContext("2d");
    ctxO.fillRect(0, 0, W, H);
    ctxO.lineJoin = "round";
    ctxO.lineCap = "round";
    function copyImg(img) {
      const can = Object.assign(document.createElement("canvas"), {width: img.width, height: img.height});
      return can;
    }

    // create video element and load media. Will call StartVideo when ready   
    const video = createVideo(mediaSource, StartVideo);
    function createVideo(mediaSource, animCallback) {
      const video = document.createElement("video"); 
      video.src = mediaSource;
      video.autoPlay = false;
      video.loop = true;
      video.muted = true;
      video.addEventListener("canplay", animCallback, {once: true});
      video.addEventListener("error", error, {once: true})  
      function error(e) { console.log("Could not load video!!! ", e); }  
      return video
    }
    function StartVideo() {
      video.play();
      renderLoop();
    }

    // Create simple mouse listeners
    const mouse = createMouse();
    function createMouse() {
      const m = {x : 0, y : 0, px: 0, py: 0, button : false, element: canvas, bound: null};  
      m.bounds = m.element.getBoundingClientRect();
      function mouseEvents(e) {
        m.x = e.pageX - m.bounds.left - scrollX;
        m.y = e.pageY - m.bounds.top - scrollY;
        mouse.button = e.type === "mousedown" ? true : e.type === "mouseup" ? false : mouse.button;
      }
      ["down", "up", "move"].forEach(name => document.addEventListener("mouse" + name, mouseEvents));
      return m;
    }

    // main render loop
    function renderLoop() {
      if (bgReady) {
        ctx.drawImage(bgImg, 0, 0, W, H);
        if (mouse.button) {
          ctxO.globalCompositeOperation = "destination-out";
          ctxO.strokeStyle = "#0008";
          ctxO.beginPath();
          ctxO.lineTo(mouse.px, mouse.py);
          ctxO.lineTo(mouse.x, mouse.y);
          ctxO.lineWidth = 30;
          ctxO.stroke();
          ctxO.lineWidth = 26;
          ctxO.stroke();
          ctxO.lineWidth = 22;
          ctxO.stroke();
          showHelp = false;   
        }
        ctxO.globalCompositeOperation = "source-atop";
        ctxO.drawImage(video, 0, 0, W, H);
        ctx.drawImage(overlay, 0, 0, W, H);
        if (showHelp) {              
          ctx.strokeText( "Click drag to reveal", 32, 62);
          ctx.fillText( "Click drag to reveal", 30, 60);
        }
      }
      mouse.px = mouse.x;
      mouse.py = mouse.y;
      requestAnimationFrame(renderLoop);
    }
  </script>
</body>
</html>
