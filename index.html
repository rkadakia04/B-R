<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Canvas Video Overlay</title>
  <style>
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <script>
    const mediaSource = "http://upload.wikimedia.org/wikipedia/commons/7/79/Big_Buck_Bunny_small.ogv";

    var showHelp = true;
    var bgReady = false;

    // create and load background image
    const bgImg = new Image;
    bgImg.src = "https://i.stack.imgur.com/C7qq2.png?s=256&g=1";
    bgImg.addEventListener("load", () => bgReady = true, {once: true});
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    // Show state and setup help settings
    ctx.font = "32px arial";
    ctx.fillText("Loading...", 30, 60);
    ctx.font = "24px arial";
    ctx.fillStyle = "#FFF";
    ctx.strokeStyle = "#000";
    ctx.lineJoin = "round";
    ctx.lineWidth = 4;  

    // setup overlay canvas
    const overlay = copyImg(canvas);
    const ctxO = overlay.getContext("2d");
    ctxO.fillRect(0, 0, canvas.width, canvas.height);
    ctxO.lineJoin = "round";
    ctxO.lineCap = "round";
    function copyImg(img) {
      const can = Object.assign(document.createElement("canvas"), {width: img.width, height: img.height});
      return can;
    }

    // create video element and load media. Will call StartVideo when ready   
    const video = createVideo(mediaSource, StartVideo);
    function createVideo(mediaSource, animCallback) {
      const video = document.createElement("video"); 
      video.src = mediaSource;
      video.autoplay = true; // Allow autoplay
      video.loop = true;
      video.muted = true;
      video.addEventListener("canplay", animCallback, {once: true});
      video.addEventListener("error", error, {once: true})  
      function error(e) { console.log("Could not load video!!! ", e); }  
      return video
    }
    function StartVideo() {
      renderLoop();
    }

    // Create simple touch listeners for mobile
    const touch = createTouch();
    function createTouch() {
      const t = {x: 0, y: 0, px: 0, py: 0, touching: false, element: canvas};  
      function touchEvents(e) {
        const touch = e.touches[0];
        t.x = touch.pageX - canvas.offsetLeft;
        t.y = touch.pageY - canvas.offsetTop;
        t.touching = e.type === "touchstart" ? true : e.type === "touchend" ? false : t.touching;
      }
      ["start", "end", "move"].forEach(name => document.addEventListener("touch" + name, touchEvents));
      return t;
    }

    // main render loop
    function renderLoop() {
      if (bgReady) {
        ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
        if (touch.touching) {
          ctxO.globalCompositeOperation = "destination-out";
          ctxO.strokeStyle = "#0008";
          ctxO.beginPath();
          ctxO.lineTo(touch.px, touch.py);
          ctxO.lineTo(touch.x, touch.y);
          ctxO.lineWidth = 30;
          ctxO.stroke();
          ctxO.lineWidth = 26;
          ctxO.stroke();
          ctxO.lineWidth = 22;
          ctxO.stroke();
          showHelp = false;   
        }
        ctxO.globalCompositeOperation = "source-atop";
        ctxO.drawImage(video, 0, 0, canvas.width, canvas.height);
        ctx.drawImage(overlay, 0, 0, canvas.width, canvas.height);
        if (showHelp) {              
          ctx.strokeText( "Touch and drag to reveal", 32, 62);
          ctx.fillText( "Touch and drag to reveal", 30, 60);
        }
      }
      touch.px = touch.x;
      touch.py = touch.y;
      requestAnimationFrame(renderLoop);
    }
  </script>
</body>
</html>
